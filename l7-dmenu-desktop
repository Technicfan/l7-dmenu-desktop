#!/bin/bash

dmenu_desktop()
{
    get_desktop_name()
    {
        [[ -f "$1" ]] && entry=$(sed -n '/\[Desktop Entry\]/,/^\[/p' "$1")
        if [[ -n $entry ]] && \
        ! grep -q "^NoDisplay=true" <<< "$entry" && \
        ! grep -q "^Hidden=true" <<< "$entry" && \
          grep -q "^Type=Application" <<< "$entry"
        then
            name=$(awk -F "=" '{print $2}' \
                   <(grep "^Name\[$2\]=" <<< "$entry" || grep "^Name=" <<< "$entry"))
            [[ -n "$name" ]] && echo "$name""; ""$1""; 1"
        fi
        [[ -z "$name" ]] && echo "hidden; ""$1""; 0"
    }

    update_desktop()
    {
        if [[ -d "$2" ]]
        then
            files=$(find "$2" -type f,l -name "*.desktop" | sort -u)
            [[ -f "$1" ]] && cached_files=$(awk -F "; " '{print $2}' "$1" | grep "$2" | sort -u)
            if [[ -z "$cached_files" ]]
            then
                export -f get_desktop_name
                parallel -j12 get_desktop_name ::: "$files" ::: "$3" >> "$1"
            elif [[ "$cached_files" != "$files" ]]
            then
                readarray -t changes < <(diff <(echo "$cached_files") <(echo "$files"))
                for change in "${changes[@]}"
                do
                    if [[ "$change" = ">"* ]]
                    then
                        file="${change//> /}"
                        get_desktop_name "$file" "$3" >> "$1"
                    elif [[ "$change" = "<"* ]]
                    then
                        file="$(sed 's/\//\\\//g' <<<"${change//< /}")"
                        name="$(grep "$file" "$1" | awk -F "; " '{print $1}')"
                        sed -i "/; $file; /d" "$1"
                        sed -i "s/^$name ([0-9])/$name/g" "$1"
                    fi
                done
            fi
        fi
    }

    touch "$3"
    for desktopdir in $1
    do
        update_desktop "$2" "$desktopdir" "$4" &
        pids+=($!)
    done
    for pid in "${pids[@]}"
    do
        wait "$pid"
    done
    awk -i inplace -F "; " '
    {
        count[$1]++
        if (count[$1] == 1 || $1 == "hidden") {
            print $0
        } else {
            print $1 " (" count[$1]-1 "); " $2 "; " $3
        }
    }
    ' "$2"
    grep "; 1$" "$2" | sed 's/;.*$//g'
    rm "$3"
}

dmenu_aliases()
{
    [[ -f "$1" ]] && grep "^alias .*=.*" "$1" | sed 's/alias //g; s/=.*$//g'
}

main()
{
    cachedir="$HOME/.cache/l7-dmenu-desktop"
    configdir="$HOME/.config/l7-dmenu-desktop"
    lockfile="$cachedir/lock_desktop"
    aliasesfile="$configdir/aliases"
    excludefile="$configdir/excludes"
    configfile="$configdir/config"
    lang=$(echo "$LANG" | awk -F "_" '{print $1}')
    appcache="$cachedir/apps"
    desktopdirs=(
        "/usr/share/applications"
        "/usr/local/share/applications"
        "$HOME/.local/share/applications"
        "/var/lib/flatpak/exports/share/applications"
        "$HOME/.local/flatpak/exports/share/applications"
    )

    checkrunning()
    {
        [[ ! -e "$cachedir" ]] && mkdir "$cachedir"
        if [[ -f "$1" ]]
        then
            echo "Already running!" >&2
            exit 1
        fi
    }

    execute()
    {
        if [[ -n $1 ]]
        then
            if [[ -f "$aliasesfile" ]] && grep -q "^alias $1=" "$aliasesfile"
            then
                eval "$(sed "s/alias $1=//g" "$aliasesfile")"
                return
            else
                if [[ -f "$appcache" ]] && grep -q "^$1;" "$appcache"
                then
                    dex --term "$term" "$(grep "^$1;" "$appcache" | awk -F "; " '{print $2}')" &
                    return
                fi
            fi
            if [[ $1 = $"~"* ]]
            then
                command="${1:1}"
            else
                command=$1
            fi
            if command -v "$(echo "$command" | awk '{print $1}')"
            then
                if [[ $(printf "No\nYes" | eval "${menu//~prompt~/\'${prompt2//~command~/\"$command\"}\'}") = "Yes" ]]
                then
                    $command
                fi
            else
                notify-send -a "l7-dmenu-desktop_error" "Invalid command"
                $0 "$2"
            fi
        fi
    }

    exclude()
    {
        list="$2"
        if [[ -f "$1" ]]
        then
            while read -r exclude
            do
                list=$(sed "/^$exclude$/d" <<< "$list")
            done < "$1"
        fi
        echo "$list"
    }

    for arg in "$@"
    do
        case $arg in
        -h|--help)
            printf '%s\n' "Use --dmenu=<menu> to change menu command" \
                "Use --clean to clear cache and rebuild it" \
                "When not using --dmenu= flag arguments are passed to regular dmenu"\
                    "instead of your desired prompt write ~prompt~ without quotation marks"
            exit 0
            ;;
        --dmenu=*)
            menu=${arg//--dmenu=/}
            ;;
        --clean)
            [[ -f "$lockfile" ]] && rm "$lockfile"
            [[ -f "$appcache" ]] && rm "$appcache"
            c=1
            ;;
        esac
    done

    checkrunning "$lockfile"
    [[ -f "$configfile" ]] && source "$configfile"
    [[ -z "$prompt1" ]] && prompt1="Run:"
    [[ -z "$prompt2" ]] && prompt2="Run ~command~ with bash?"
    [[ -z "$term" ]] && term="alacritty"
    echo -ne "looking for changes..." && \
    if [[ $addpath = 1 ]]
    then
        entries=$(exclude "$excludefile" "$( (dmenu_desktop "${desktopdirs[*]}" "$appcache" "$lockfile" "$lang" & \
                                              dmenu_aliases "$aliasesfile" & dmenu_path) 2>/dev/null )")
    else
        entries=$(exclude "$excludefile" "$( (dmenu_desktop "${desktopdirs[*]}" "$appcache" "$lockfile" "$lang" & \
                                              dmenu_aliases "$aliasesfile") 2>/dev/null )")
    fi && \
    echo -ne "\r\033[K"
    echo "Read $(wc -l < "$appcache") .desktop files, found $(wc -l < <(grep "; 1$" "$appcache")) apps." &
    if [[ -z "$menu" ]]
    then
        if [[ $c = 1 ]]
        then
            menu="dmenu ${*//--clean/}"
        elif [[ "$*" != ".*-p .*" ]]
        then
            menu="dmenu $* -p ~prompt~"
        else
            menu="dmenu $*"
        fi
    fi
    selection=$(echo "${entries[@]}" | sort -u | ${menu//~prompt~/$prompt1})
    execute "$selection" "$*"
}

main "$@"